<!DOCTYPE html>
<html lang="en">
<head>
    <title>Christchurch Bus Route Optimizer</title>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="https://example.com/map-icon.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This sample shows bus routes and trips on Azure Maps using external APIs." />
    <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, services, bus routes, bus trips, Azure Maps" />
    <meta name="author" content="Microsoft Azure Maps" />
    <meta name="version" content="1.0" />
    <meta name="screenshot" content="screenshot.jpg" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>

    <!-- Add custom CSS for styling -->
    <style>
        html, body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
        }
        #title {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
        }
        #myMap {
            width: 100%;
            height: calc(100% - 80px); /* Adjust height to account for the title and some padding */
        }
        #controls {
            position: absolute;
            top: 70px;
            left: 15px;
            display: flex;
            gap: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        fieldset {
            width: calc(100% - 30px);
            min-width: 290px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="title">Christchurch Bus Route Optimizer</div>
    <div id="myMap"></div>

    <div id="controls">
        <select id="busRoutesDropdown">
            <option value="">Select a bus route...</option>
        </select>
        <select id="busTripsDropdown">
            <option value="">Select a bus trip...</option>
        </select>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map, datasource;

            // Initialize map and datasource
            map = new atlas.Map('myMap', {
                view: 'Auto',

                // Add authentication details for connecting to Azure Maps.
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'ga6N-Pxs9QImElvXeg3J3H7UQRcVk_zRXejD8NJQt6E'
                }
            });

            map.events.add('ready', function () {
                // Create a data source once the map is ready.
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                // Load bus routes when the map is ready.
                loadBusRoutes();
            });

            async function loadBusRoutes() {
                try {
                    // Call external API to fetch list of bus routes
                    const response = await fetch('https://busmetroapiapp.azurewebsites.net/api/Maps/GetAllRoutes');
                    const routesData = await response.json();

                    // Populate dropdown menu with bus routes
                    const dropdown = document.getElementById('busRoutesDropdown');
                    dropdown.innerHTML = '<option value="">Select a bus route...</option>'; // Clear existing options and add default
                    routesData.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.route_id;
                        option.textContent = `${route.route_short_name} - ${route.route_long_name}`;
                        dropdown.appendChild(option);
                    });

                    // Trigger loading of trips when a route is selected
                    dropdown.addEventListener('change', async function() {
                        const selectedRouteId = this.value;
                        if (selectedRouteId) {
                            await loadTrips(selectedRouteId);
                        }
                    });
                } catch (error) {
                    console.error('Error loading bus routes:', error);
                    alert('Failed to load bus routes');
                }
            }

            async function loadTrips(routeId) {
                try {
                    // Call external API to fetch list of trips for selected bus route
                    const response = await fetch(`https://busmetroapiapp.azurewebsites.net/api/Maps/GetAllTripsByRoute?RouteID=${routeId}`);
                    const tripsData = await response.json();

                    // Populate dropdown menu with trips
                    const dropdown = document.getElementById('busTripsDropdown');
                    dropdown.innerHTML = '<option value="">Select a bus trip...</option>'; // Clear existing options and add default
                    tripsData.forEach(trip => {
                        const option = document.createElement('option');
                        option.value = trip.trip_id; // Assuming tripId is the property that holds the unique identifier for the trip
                        option.textContent = trip.trip_headsign; // Assuming tripName is the property that holds the name of the trip
                        dropdown.appendChild(option);
                    });

                    // Trigger loading of coordinates when a trip is selected
                    dropdown.addEventListener('change', async function() {
                        const selectedTripId = this.value;
                        if (selectedTripId) {
                            await loadCoordinates(routeId, selectedTripId);
                        }
                    });
                } catch (error) {
                    console.error('Error loading trips for bus route:', error);
                    alert('Failed to load trips for bus route');
                }
            }

            async function loadCoordinates(routeId, tripId) {
                try {
                    // Call external API to fetch list of coordinates for selected bus route and trip
                    const response = await fetch(`https://busmetroapiapp.azurewebsites.net/api/Maps/GetTripData?RouteId=${routeId}&TripID=${tripId}`);
                    const coordinatesData = await response.json();

                    // Clear existing data
                    datasource.clear();

                    // Add coordinates to the datasource
                    const coordinates = coordinatesData.map(coord => ({
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [coord.stop_lon, coord.stop_lat]
                        }
                    }));
                    datasource.add(coordinates);

                    if (coordinates.length > 0) {
                        // Create a LineString from the coordinates.
                        const lineStringCoordinates = coordinates.map(coord => coord.geometry.coordinates);
                        const lineString = new atlas.Shape(new atlas.data.LineString(lineStringCoordinates));

                        // Add the LineString to the data source.
                        datasource.add(lineString);
                        
                        // Fit map view to the LineString bounds.
                        map.setCamera({
                            bounds: lineString.getBounds(),
                            padding: 50
                        });
                    }
                } catch (error) {
                    console.error('Error loading coordinates:', error);
                    alert('Failed to load coordinates');
                }
            }

        });
    </script>
</body>
</html>
