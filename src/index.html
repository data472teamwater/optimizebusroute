<!DOCTYPE html>
<html lang="en">
<head>
    <title>Christchurch Bus Route Optimizer</title>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="https://example.com/map-icon.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This sample shows bus routes and trips on Azure Maps using external APIs." />
    <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, services, bus routes, bus trips, Azure Maps" />
    <meta name="author" content="Microsoft Azure Maps" />
    <meta name="version" content="1.0" />
    <meta name="screenshot" content="screenshot.jpg" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>

    <!-- Add custom CSS for styling -->
    <style>
        html, body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
        }
        #title {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
        }
        #myMap {
            width: 100%;
            height: calc(100% - 80px); /* Adjust height to account for the title and some padding */
        }
        #controls {
            position: absolute;
            top: 70px;
            left: 15px;
            display: flex;
            gap: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        fieldset {
            width: calc(100% - 30px);
            min-width: 290px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="title">Christchurch Bus Route Optimizer</div>
    <div id="myMap"></div>

    <div id="controls">
        <select id="busRoutesDropdown">
            <option value="">Select a bus route...</option>
        </select>
        <select id="busTripsDropdown">
            <option value="">Select a bus trip...</option>
        </select>
    </div>

    <script>
       function simplifyPolyline(polyline, tolerance) {
    if (polyline.length <= 2) {
        return polyline; // Can't simplify further
    }
    
    // Find the point with the maximum distance
    let maxDistance = 0;
    let maxIndex = 0;
    const end = polyline.length - 1;
    const start = 0;
    for (let i = start + 1; i < end; i++) {
        const distance = perpendicularDistance(polyline[i], polyline[start], polyline[end]);
        if (distance > maxDistance) {
            maxDistance = distance;
            maxIndex = i;
        }
    }

    // If the maximum distance is greater than the tolerance, recursively simplify
    if (maxDistance > tolerance) {
        const leftPart = simplifyPolyline(polyline.slice(start, maxIndex + 1), tolerance);
        const rightPart = simplifyPolyline(polyline.slice(maxIndex, end + 1), tolerance);
        return leftPart.slice(0, leftPart.length - 1).concat(rightPart);
    } else {
        return [polyline[start], polyline[end]];
    }
}

// Function to calculate the perpendicular distance from a point to a line segment
function perpendicularDistance(point, start, end) {
    const numerator = Math.abs((end[1] - start[1]) * point[0] - (end[0] - start[0]) * point[1] + end[0] * start[1] - end[1] * start[0]);
    const denominator = Math.sqrt(Math.pow(end[1] - start[1], 2) + Math.pow(end[0] - start[0], 2));
    return numerator / denominator;
}

        document.addEventListener('DOMContentLoaded', function () {
            var map, datasource;

            // Initialize map and datasource
            map = new atlas.Map('myMap', {
                view: 'Auto',

                // Add authentication details for connecting to Azure Maps.
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'ga6N-Pxs9QImElvXeg3J3H7UQRcVk_zRXejD8NJQt6E' // Replace with your actual subscription key
                }
            });

            map.events.add('ready', function () {
                // Create a data source once the map is ready.
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                // Add a layer for the line to make it visible
                map.layers.add(new atlas.layer.LineLayer(datasource, null, {
                    strokeColor: 'blue', // Color of the line
                    strokeWidth: 3 // Width of the line
                }));

                // Load bus routes when the map is ready.
                loadBusRoutes();
            });

            async function loadBusRoutes() {
                try {
                    // Call external API to fetch list of bus routes
                    const response = await fetch('https://busmetroapiapp.azurewebsites.net/api/Maps/GetAllRoutes');
                    const routesData = await response.json();

                    // Populate dropdown menu with bus routes
                    const dropdown = document.getElementById('busRoutesDropdown');
                    dropdown.innerHTML = '<option value="">Select a bus route...</option>'; // Clear existing options and add default
                    routesData.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.route_id;
                        option.textContent = `${route.route_short_name} - ${route.route_long_name}`;
                        dropdown.appendChild(option);
                    });

                    // Trigger loading of trips when a route is selected
                    dropdown.addEventListener('change', async function() {
                        const selectedRouteId = this.value;
                        if (selectedRouteId) {
                            await loadTrips(selectedRouteId);
                        }
                    });
                } catch (error) {
                    console.error('Error loading bus routes:', error);
                    alert('Failed to load bus routes');
                }
            }

            async function loadTrips(routeId) {
                try {
                    // Call external API to fetch list of trips for selected bus route
                    const response = await fetch(`https://busmetroapiapp.azurewebsites.net/api/Maps/GetAllTripsByRoute?RouteID=${routeId}`);
                    const tripsData = await response.json();

                    // Populate dropdown menu with trips
                    const dropdown = document.getElementById('busTripsDropdown');
                    dropdown.innerHTML = '<option value="">Select a bus trip...</option>'; // Clear existing options and add default
                    tripsData.forEach(trip => {
                        const option = document.createElement('option');
                        option.value = trip.trip_id; // Assuming tripId is the property that holds the unique identifier for the trip
                        option.textContent = trip.trip_headsign; // Assuming tripName is the property that holds the name of the trip
                        dropdown.appendChild(option);
                    });

                    // Trigger loading of coordinates when a trip is selected
                    dropdown.addEventListener('change', async function() {
                        const selectedTripId = this.value;
                        if (selectedTripId) {
                            await loadCoordinates(routeId, selectedTripId);
                        }
                    });
                } catch (error) {
                    console.error('Error loading trips for bus route:', error);
                    alert('Failed to load trips for bus route');
                }
            }

            async function loadCoordinates(routeId, tripId) {
    try {
        // Call external API to fetch list of coordinates for selected bus route and trip
        const response = await fetch(`https://busmetroapiapp.azurewebsites.net/api/Maps/GetTripData?RouteId=${routeId}&TripID=${tripId}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch coordinates data');
        }

        const coordinatesData = await response.json();

        // Verify if coordinatesData is an array and contains data
        if (!Array.isArray(coordinatesData) || coordinatesData.length === 0) {
            throw new Error('Coordinates data is empty or invalid');
        }

        // Clear existing data
        datasource.clear();

        // Extract longitude and latitude coordinates
        const coordinates = coordinatesData.map(coord => [coord.stop_lon, coord.stop_lat]);

        if (coordinates.length > 1) {
            // Calculate bounding box manually
            let minLon = Number.POSITIVE_INFINITY;
            let maxLon = Number.NEGATIVE_INFINITY;
            let minLat = Number.POSITIVE_INFINITY;
            let maxLat = Number.NEGATIVE_INFINITY;

            coordinates.forEach(coord => {
                minLon = Math.min(minLon, coord[0]);
                maxLon = Math.max(maxLon, coord[0]);
                minLat = Math.min(minLat, coord[1]);
                maxLat = Math.max(maxLat, coord[1]);
            });

            // Create bounding box
            const bounds = new atlas.data.BoundingBox([minLon, minLat], [maxLon, maxLat]);

            // Fetch routes between consecutive coordinates
            const routes = await fetchRoutesBetweenCoordinates(coordinates);

            // Draw the obtained routes on the map
            routes.forEach(route => {
                const lineString = new atlas.data.LineString(route);
                const shape = new atlas.Shape(lineString);
                datasource.add(shape);
            });

            // Fit map view to the bounding box bounds.
            map.setCamera({
                bounds: bounds,
                padding: 50
            });
        } else {
            throw new Error('Not enough coordinates to draw a route');
        }
    } catch (error) {
        console.error('Error loading coordinates:', error);
        alert('Failed to load coordinates: ' + error.message);
    }
}




async function fetchRoutesBetweenCoordinates(coordinates) {
    const routes = [];
    for (let i = 0; i < coordinates.length - 1; i++) {
        const startPoint = coordinates[i];
        const endPoint = coordinates[i + 1];
        const route = await fetchRoute(startPoint, endPoint);
        routes.push(route);
    }
    return routes;
}

async function fetchRoute(startPoint, endPoint) {
    const response = await fetch(`https://atlas.microsoft.com/route/directions/json?subscription-key=ga6N-Pxs9QImElvXeg3J3H7UQRcVk_zRXejD8NJQt6E&api-version=1.0&query=${startPoint[1]},${startPoint[0]}:${endPoint[1]},${endPoint[0]}`);
    const data = await response.json();
    const route = data.routes[0].legs[0].points.map(point => [point.longitude, point.latitude]);
    return route;
            }


        });
    </script>
</body>
</html>
